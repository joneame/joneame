<?php
// The source code packaged with this file is Free Software, Copyright (C) 2010 by
// JonÃ©ame Development Team (admin@joneame.net)
// It's licensed under the AFFERO GENERAL PUBLIC LICENSE unless stated otherwise.
// A copy of the AFFERO GENERAL PUBLIC LICENSE is included in the file "COPYING".

include('config.php');
include(mnminclude.'link.php');

$user_id = intval($_GET['user_id']);
$option = $_GET['option'];

switch ($option) {
    case 'joneadas':
        $sql = "SELECT link_id FROM links, votes WHERE vote_type='links' and vote_user_id=$user_id AND vote_link_id=link_id  and vote_value > 0 ORDER BY link_id DESC LIMIT 1000";
        do_header(_('joneadas'));
        do_link_item($sql);
        do_footer();
        break;
    case 'favoritos':
          $sql = "SELECT link_id FROM links, favorites WHERE favorite_user_id=$user_id AND favorite_type='link' AND favorite_link_id=link_id  ORDER BY link_id DESC LIMIT 1000";
        do_header(_('favoritos'));
        do_link_item($sql);
        do_footer();
        break;
    case 'chorradas':
        $sql = "SELECT distinct(link_id) FROM links, comments WHERE comment_user_id=$user_id and link_id=comment_link_id and comment_type != 'admin' ORDER BY link_id DESC LIMIT 1000";
        do_header(_('chorradas'));
        do_link_item($sql);
        do_footer();
        break;
    case 'enviadas':
        $sql = "SELECT link_id FROM links WHERE link_author=$user_id ORDER BY link_id DESC LIMIT 1000";
        do_header(_('enviadas'));
        do_link_item($sql);
        do_footer();
        break;
    default:
        die;
}

function do_header($title) {
    echo '<!DOCTYPE NETSCAPE-Bookmark-file-1>';
    echo '<!-- This file was generated by Joneame -->';
    echo '<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">';
    echo '<TITLE>Bookmarks</TITLE>';
    echo '<H1 LAST_MODIFIED="'.time().'">Bookmarks</H1>';
    echo '<DL><P>';
    echo '<DT><H3 FOLDED >'.$title.'//'.get_server_name().'</H3>';
    echo '<DL><P>';
}

function do_footer() {
    echo '</DL>';
}

function do_link_item($sql) {
    global $db;

    $link = new Link;
    $links = $db->get_col($sql);
    if ($links) {
        foreach($links as $link_id) {
            $link->id=$link_id;
            $link->read();
            if ($_REQUEST['url'] == 'source') {
                $url = htmlentities($link->url);
            } else {
                $url = $link->get_permalink();
            }
            echo '<DT><A HREF="'.$url.'" REL="nofollow">'.$link->title.'</A>';
        }
    }
}